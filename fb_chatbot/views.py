#!/usr/bin/env python
# -*- coding: utf-8 -*-

import json, requests, random, re
from pprint import pprint

from django.shortcuts import render
from django.http import HttpResponse

from django.views import generic
from django.views.decorators.csrf import csrf_exempt
from django.utils.decorators import method_decorator

# Create your views here.

PAGE_ACCESS_TOKEN = 'EAAQA1ZA0bZBB0BAKHYZA0AIgslS75KYQVheP0eIH6r5JKXZArYl3FWJzAksixxZBpP55BqfSUavhOQ8PhaHcM4kovmJQNTmfdkdQKkjup0wN9u9Yf8PSiB6ydAc9BSex5KjKQqaKWwuXqNOid9eRWwFIZBsFoXinZAVa6z5rwnN7wZDZD'
VERIFY_TOKEN = '8447789934m'

#xkcd_list = [{u'img': u'http://imgs.xkcd.com/comics/barrel_cropped_(1).jpg', u'title': u'Barrel - Part 1', u'month': u'1', u'num': 1, u'link': u'', u'year': u'2006', u'news': u'', u'safe_title': u'Barrel - Part 1', u'transcript': u"[[A boy sits in a barrel which is floating in an ocean.]]\nBoy: I wonder where I'll float next?\n[[The barrel drifts into the distance. Nothing else can be seen.]]\n{{Alt: Don't we all.}}", u'alt': u"Don't we all.", u'day': u'1'}, {u'img': u'http://imgs.xkcd.com/comics/tree_cropped_(1).jpg', u'title': u'Petit Trees (sketch)', u'month': u'1', u'num': 2, u'link': u'', u'year': u'2006', u'news': u'', u'safe_title': u'Petit Trees (sketch)', u'transcript': u"[[Two trees are growing on opposite sides of a sphere.]]\n{{Alt-title: 'Petit' being a reference to Le Petit Prince, which I only thought about halfway through the sketch}}", u'alt': u"'Petit' being a reference to Le Petit Prince, which I only thought about halfway through the sketch", u'day': u'1'}, {u'img': u'http://imgs.xkcd.com/comics/island_color.jpg', u'title': u'Island (sketch)', u'month': u'1', u'num': 3, u'link': u'', u'year': u'2006', u'news': u'', u'safe_title': u'Island (sketch)', u'transcript': u'[[A sketch of an Island]]\n{{Alt:Hello, island}}', u'alt': u'Hello, island', u'day': u'1'}, {u'img': u'http://imgs.xkcd.com/comics/landscape_cropped_(1).jpg', u'title': u'Landscape (sketch)', u'month': u'1', u'num': 4, u'link': u'', u'year': u'2006', u'news': u'', u'safe_title': u'Landscape (sketch)', u'transcript': u"[[A sketch of a landscape with sun on the horizon]]\n{{Alt: There's a river flowing through the ocean}}", u'alt': u"There's a river flowing through the ocean", u'day': u'1'}]

xkcd_list = [{u'img': u'http://imgs.xkcd.com/comics/barrel_cropped_(1).jpg', u'title': u'Barrel - Part 1', u'month': u'1', u'num': 1, u'link': u'', u'year': u'2006', u'news': u'', u'safe_title': u'Barrel - Part 1', u'transcript': u"[[A boy sits in a barrel which is floating in an ocean.]]\nBoy: I wonder where I'll float next?\n[[The barrel drifts into the distance. Nothing else can be seen.]]\n{{Alt: Don't we all.}}", u'alt': u"Don't we all.", u'day': u'1'}, {u'img': u'http://imgs.xkcd.com/comics/tree_cropped_(1).jpg', u'title': u'Petit Trees (sketch)', u'month': u'1', u'num': 2, u'link': u'', u'year': u'2006', u'news': u'', u'safe_title': u'Petit Trees (sketch)', u'transcript': u"[[Two trees are growing on opposite sides of a sphere.]]\n{{Alt-title: 'Petit' being a reference to Le Petit Prince, which I only thought about halfway through the sketch}}", u'alt': u"'Petit' being a reference to Le Petit Prince, which I only thought about halfway through the sketch", u'day': u'1'}, {u'img': u'http://imgs.xkcd.com/comics/island_color.jpg', u'title': u'Island (sketch)', u'month': u'1', u'num': 3, u'link': u'', u'year': u'2006', u'news': u'', u'safe_title': u'Island (sketch)', u'transcript': u'[[A sketch of an Island]]\n{{Alt:Hello, island}}', u'alt': u'Hello, island', u'day': u'1'}, {u'img': u'http://imgs.xkcd.com/comics/landscape_cropped_(1).jpg', u'title': u'Landscape (sketch)', u'month': u'1', u'num': 4, u'link': u'', u'year': u'2006', u'news': u'', u'safe_title': u'Landscape (sketch)', u'transcript': u"[[A sketch of a landscape with sun on the horizon]]\n{{Alt: There's a river flowing through the ocean}}", u'alt': u"There's a river flowing through the ocean", u'day': u'1'}, {u'img': u'http://imgs.xkcd.com/comics/blownapart_color.jpg', u'title': u'Blown apart', u'month': u'1', u'num': 5, u'link': u'', u'year': u'2006', u'news': u'', u'safe_title': u'Blown apart', u'transcript': u'[[A black number 70 sees a red package.]]\n70: hey, a package!\n[[The package explodes with a <<BOOM>> and a red cloud of smoke.]]\n[[There are a red 7, a green 5 and a blue 2 lying near a scorched mark on the floor.]]\n{{alt text: Blown into prime factors}}', u'alt': u'Blown into prime factors', u'day': u'1'}, {u'img': u'http://imgs.xkcd.com/comics/irony_color.jpg', u'title': u'Irony', u'month': u'1', u'num': 6, u'link': u'', u'year': u'2006', u'news': u'', u'safe_title': u'Irony', u'transcript': u"Narrator: When self-reference, irony, and meta-humor go too far\nNarrator: A CAUTIONARY TALE\nMan 1: This statement wouldn't be funny if not for irony!\nMan 1: ha ha\nMan 2: ha ha, I guess.\nNarrator: 20,000 years later...\n[[desolate badlands landscape with an imposing sun in the sky]]\n{{It's commonly known that too much perspective can be a downer.}}", u'alt': u"It's commonly known that too much perspective can be a downer.", u'day': u'1'}, {u'img': u'http://imgs.xkcd.com/comics/girl_sleeping_noline_(1).jpg', u'title': u'Girl sleeping (Sketch -- 11th grade Spanish class)', u'month': u'1', u'num': 7, u'link': u'', u'year': u'2006', u'news': u'', u'safe_title': u'Girl sleeping (Sketch -- 11th grade Spanish class)', u'transcript': u'[[Girl sleeping on her side, facing away from view]]', u'alt': u"I don't remember her name at all, but she fell asleep on the floor in front of me.", u'day': u'1'}, {u'img': u'http://imgs.xkcd.com/comics/red_spiders_small.jpg', u'title': u'Red spiders', u'month': u'1', u'num': 8, u'link': u'', u'year': u'2006', u'news': u'', u'safe_title': u'Red spiders', u'transcript': u'[[Many red spiders standing on and hanging from cuboids. The cuboids hang in the air with no visible means of support.]]\n{{They are six-legged spiders}}', u'alt': u'They are six-legged spiders', u'day': u'1'}, {u'img': u'http://imgs.xkcd.com/comics/firefly.jpg', u'title': u'Serenity is coming out tomorrow', u'month': u'1', u'num': 9, u'link': u'', u'year': u'2006', u'news': u'', u'safe_title': u'Serenity is coming out tomorrow', u'transcript': u'[[Several stick figures stand side by side in a lineup. A forlorn male in a coat, a male with combed hair, a male with spiky hair and arms outstretched enthusiastically, a female with long hair and cornrows, a shorter female with stringy hair falling over her face, an enthusiastic female with arms raised in celebration with shorter hair, a male with short hair and a goatee, a female with curly hair wearing a dress, and a stern-looking man with flyaway hair. There is no dialogue.]] \n{{Alt: Mal, Simon, Wash, Zoe, River, Kaylee, Jayne, Inara, Book.}}', u'alt': u'Mal, Simon, Wash, Zoe, River, Kaylee, Jayne, Inara, Book.', u'day': u'1'}, {u'img': u'http://imgs.xkcd.com/comics/pi.jpg', u'title': u'Pi Equals', u'month': u'1', u'num': 10, u'link': u'', u'year': u'2006', u'news': u'', u'safe_title': u'Pi Equals', u'transcript': u'Pi = 3.141592653589793helpimtrappedinauniversefactory7108914...', u'alt': u'My most famous drawing, and one of the first I did for the site', u'day': u'1'}, {u'img': u'http://imgs.xkcd.com/comics/barrel_mommies.jpg', u'title': u'Barrel - Part 2', u'month': u'1', u'num': 11, u'link': u'', u'year': u'2006', u'news': u'', u'safe_title': u'Barrel - Part 2', u'transcript': u'[[A boy sits in a barrel which is floating in an ocean.]]\nBoy: None of the places i floated had mommies.\n{{Alt: Awww.}}', u'alt': u'Awww.', u'day': u'1'}, {u'img': u'http://imgs.xkcd.com/comics/poisson.jpg', u'title': u'Poisson', u'month': u'1', u'num': 12, u'link': u'', u'year': u'2006', u'news': u'', u'safe_title': u'Poisson', u'transcript': u"[[A stick figure says to another black-hat-wearing figure.]]\nMan: I'm a poisson distribution!\nMan: Still a poisson distribution.\nHat Guy: What the hell, man.  Why do you keep saying that?\nMan: Because I'm totally a poisson distribution.\nHat Guy: I'm less than zero.\n[[Man is gone; Hat Guy is whistling.]]\n{{alt text: Poisson distributions have no value over negative numbers}}", u'alt': u'Poisson distributions have no value over negative numbers', u'day': u'1'}, {u'img': u'http://imgs.xkcd.com/comics/canyon_small.jpg', u'title': u'Canyon', u'month': u'1', u'num': 13, u'link': u'', u'year': u'2006', u'news': u'', u'safe_title': u'Canyon', u'transcript': u"[[Two men are standing at some kind of cliff edge]]\nMan 1: What time is it?\nMan 2: Now.\n[[Full scene is revealed: the men are standing at the edge of a huge canyon in a rocky, barren landscape. A pock-marked moon and a ringed planet are visible in the burgundy-coloured sky]]\nMan 1: That's a pretty boring answer.\nMan 2: Is not.\nMan 2: It's the least boring answer imaginable.\n{{Alt text: They're standing at the lip of the canyon, which isn't clear at all.}}", u'alt': u"They're standing at the lip of the canyon, which isn't clear at all.", u'day': u'1'}, {u'img': u'http://imgs.xkcd.com/comics/copyright.jpg', u'title': u'Copyright', u'month': u'1', u'num': 14, u'link': u'', u'year': u'2006', u'news': u'', u'safe_title': u'Copyright', u'transcript': u"[[Colored drawing of a hilly grassy landscape, stick figure leaning against a tree.]]\nMan: Sometimes I just can't get outraged over copyright law\n{{Alt: After reading Slashdot and BoingBoing, sometimes I have to go outside.}}", u'alt': u'After reading Slashdot and BoingBoing, sometimes I have to go outside.', u'day': u'1'}, {u'img': u'http://imgs.xkcd.com/comics/just_alerting_you.jpg', u'title': u'Just Alerting You', u'month': u'1', u'num': 15, u'link': u'', u'year': u'2006', u'news': u'', u'safe_title': u'Just Alerting You', u'transcript': u'[[There is a man standing on top of a dinosaur (Brontosaurus?) and holding reins to the dinosaurs head.]]\nMan: Before you talk to me, I should warn you: I am kind of strange\n{{title text: Just thought you should know}}', u'alt': u'Just thought you should know', u'day': u'1'}, {u'img': u'http://imgs.xkcd.com/comics/monty_python.jpg', u'title': u'Monty Python -- Enough', u'month': u'1', u'num': 16, u'link': u'', u'year': u'2006', u'news': u'', u'safe_title': u'Monty Python -- Enough', u'transcript': u'Character #1 [[Raising his hands]]: We are the knights who say... Ni!!\nTwo guys and a girl: hahaha\n[[written]] Does anyone else find it funny that decades later, people are still groting --word-for-word-- a group loved for its mastery of shock, the unexpected and defiance of cocnvention?\n[[Two guys looking at a third]]\nThird guy: We are the knights who... Oh, God, I\'m so sorry\n[[Close up to Third guy\'s face]]\nThird guy: So sorry the car just came too fast and\n[[Words crumpled inside the panel, there\'s barely enough space for the third guy]]\nThird guy: She was right there and I sasw her and then it was a blur and so much I ran to help didn\'t know she wasn\'t moving I\'m so sorry ... so sorry\n[[Same two guys looking again at the third guy]]\nThird guy: Anyway, yeah, knights who say "Ni".\n[[Written centered, in markee format]]\n<u>Honor <\nu>\nMonty Python:\nPromote surreal humor.\n{{Tag: I went to a dinner where there was a full 10 minutes of Holy Grail quotes exchanged w...}}', u'alt': u'I went to a dinner where there was a full 10 minutes of Holy Grail quotes exchanged, with no context, in lieu of conversation.  It depressed me badly.', u'day': u'1'}, {u'img': u'http://imgs.xkcd.com/comics/what_if.jpg', u'title': u'What If', u'month': u'1', u'num': 17, u'link': u'', u'year': u'2006', u'news': u'', u'safe_title': u'What If', u'transcript': u"[[A large black circle with white bubbles inside it, filled with hearts, question marks, and stick figure couples]]\nWhat if this isn't everything it should be?\nI'm not even sure how I feel\nWhat if I'm making a mistake?\n{{Title text: I once made an anniversary card for my then-girlfriend with this layout.}}", u'alt': u'I once made an anniversary card for my then-girlfriend with this layout.', u'day': u'1'}, {u'img': u'http://imgs.xkcd.com/comics/snapple.jpg', u'title': u'Snapple', u'month': u'1', u'num': 18, u'link': u'', u'year': u'2006', u'news': u'', u'safe_title': u'Snapple', u'transcript': u"{{Author's Comment: This one is entirely James' fault.}}\n[[Two guys are standing and talking.]]\nRight Guy: Here, take a bite of this Snapple.\nLeft Guy: food!\n[[Guy on the right takes a bite]]\nRight Guy: Ow! What is this? \n<<CLINK>>\nLeft Guy: It's an apple infused with tin.\n[[The two guys continue to stand as if frozen]]\n \n{{Author's Comment: Those of you who know your periodic table should be laughing right about now.}} \n{{Title Text: Sn= tin}}", u'alt': u'Sn = tin', u'day': u'1'}, {u'img': u'http://imgs.xkcd.com/comics/george_clinton.jpg', u'title': u'George Clinton', u'month': u'1', u'num': 19, u'link': u'', u'year': u'2006', u'news': u'', u'safe_title': u'George Clinton', u'transcript': u'Narrator: I once tried to start the urban legend that George Clinton has a B.A. in mathematics\n[[George Clinton indicates equations on a blackboard]]\nNarrator: ...but I wanted it to be true so badly that I started believing it myself.\n{{Title text: I still wish it were true.}}', u'alt': u'I still wish it were true.', u'day': u'1'}, {u'img': u'http://imgs.xkcd.com/comics/ferret.jpg', u'title': u'Ferret', u'month': u'1', u'num': 20, u'link': u'', u'year': u'2006', u'news': u'', u'safe_title': u'Ferret', u'transcript': u"[[A ferret with airplane wings on it]]\nFriend: Why on earth did you make those wings? You don't seriously think they could let your ferret fly, right?\nGuy: I... of course not.\nGuy: That would be pretty dumb. It's just, uh... ...a Halloween costume.\nFriend: oh, okay.\nFriend: Besides, who would want a pet to fly anyway?\nGuy: Yeah. Pretty lame, huh?\nFriend: Anyway, let's go play video games.\n[[Friend leaves]]\n[[Friend is gone, and Guy is looking at ferret]]\n[[Guy imagines ferret flying over the ocean near the beach using his makeshift wings]]\n{{title text: My brother had a ferret he loved which died since I drew this strip. RIP.}}", u'alt': u'My brother had a ferret he loved which died since I drew this strip.  RIP.', u'day': u'1'}, {u'img': u'http://imgs.xkcd.com/comics/kepler.jpg', u'title': u'Kepler', u'month': u'1', u'num': 21, u'link': u'', u'year': u'2006', u'news': u'', u'safe_title': u'Kepler', u'transcript': u"[[ Two people stand in an aisle in a store ]]\nPerson 1: Nice store. How do you keep the floors so clean?\nPerson 2: Oh, we hired this dude named Kepler, he's really good hard worker.  Doesn't mind the monotony. Sweeps out the same area every night.\n{{ alt: Science joke. You should probably just move along. }}", u'alt': u'Science joke.  You should probably just move along.', u'day': u'1'}, {u'img': u'http://imgs.xkcd.com/comics/barrel_whirlpool.jpg', u'title': u'Barrel - Part 3', u'month': u'1', u'num': 22, u'link': u'', u'year': u'2006', u'news': u'', u'safe_title': u'Barrel - Part 3', u'transcript': u'[[Large vortex, spinning water covers the whole panel. A boy in a floating barrel is near the edge, apparently about to be sucked in.]]\nBoy: Wow!\n{{alt text: A whirlpool!}}', u'alt': u'A whirlpool!', u'day': u'1'}, {u'img': u'http://imgs.xkcd.com/comics/t-shirts.jpg', u'title': u'T-shirts', u'month': u'1', u'num': 23, u'link': u'', u'year': u'2006', u'news': u'', u'safe_title': u'T-shirts', u'transcript': u"[[A collection of phrases on T-shirts]]\nI see dumb people\nAs a matter of fact the world DOES revolve around me\nI can only please one person per day today is not your day.\nYou know what your problem is? You're stupid.\nGet a clue\nDo I look like a people person?\nYour village called they want their idiot back\nGo away\nI hate you all\nDIE.\nHelp.\nMaybe if this T-shirt is witty enough, someone will finally love me.\nOh God I'm so alone\n{{Alt: It's depressing how many of these are real shirts}}", u'alt': u"It's depressing how many of these are real shirts", u'day': u'1'}, {u'img': u'http://imgs.xkcd.com/comics/godel_escher_kurthalsey.jpg', u'title': u'Godel, Escher, Kurt Halsey', u'month': u'1', u'num': 24, u'link': u'', u'year': u'2006', u'news': u'', u'safe_title': u'Godel, Escher, Kurt Halsey', u'transcript': u"Drawn during an unending NASA lecture.\n\n[[Two people are talking, one in a hat.]]\nHatless: it's just so hard to compare kids now with kids in the past. you can't help but to belong to one group or the other.\n\nHatless: and of course every generation seems awful to the one before it. look at quotes from throughout history.\n\nHatted: yeah, and it sure would be nice to have some perspective on some of this stuff. I just don't know what to make of it.\n[[Circles are appearing--maybe snow?]]\n\nHatless: i guess you do what you can to help the people around you and hope it turns out okay.\n\nHatless: in the end, what else can you do?\n\nHatted: lead a crusade?\n\n[[We can no longer see the people, just the circles.]]\nit's presentism, man. the idea that historical context is irrelevant, that we understand it all\n\nthat we need take no warnings from the follies of the past. that we're facing something new.\n\nsocrates couldn't imagine the internet. but people don't change.\n[[We can start to see the corner of a darker circle in the lower right.]]\n\n((The borders between the three panels on this line are cracking.))\n\nhave you seen those collections of historical pornography? talk about historical context.\n\ndid you know the first porn photo was bestial in [[inside a circle:]] nature?\n\nat least that stuff was out of the mainstream [[each word in one circle:]] no just in history\n\n((the three panels have merged into one on each row.))\n\ni don't know about you, but [[circled]] I [[uncircled]] never\neven once seen\n[[The circles are highly variable in size now, and pressed up against a larger one on the right side.]]\n\n[[There is mass of circles of different sizes, with some dark fissures in between, against the side of a large circle which we can see part of in the right half of the panel. They look like cells. There's a tiny square in the center of the giant cell.]]\n\n[[We see only the tiny square, centered. It has a few marks inside it.]]\n\n[[Closer, the square is divided into rectangles of different sizes, each of which has text in it.]]\n\n[[Much closer, we can see fragments of the text. Some are sideways, some are cut off, some are too small to read.]]\nmachine language translated by principles of isomorphism it is a consequence of the Church-Turing thesis that ...\nbut how do you select the channel you wish to se-\nthou ... shou ... palin ... stri ... it is a ... crab ...\n\n[[Closer still, we can just see a huge sideways s and h.]]\n\n[[Those letters are faded and mixed with a faded version of the next panel.]]\n\ngirls take boys away ...\nnever be further than a phone call and a goosebumped shiver away ...\ndrove all night listening to mix tapes ...\nthe past is just practice\n[[There is a heart at the bottom and, in the lower left, the name Kurt.]]\n\n[[The same as the previous panel, but with the words blurred out to scribbles.]]\n\n[[Jagged, shaded shapes and strands start to fall. Faint panel borders appear again. There is a person on the far right.]]\n\n((Back to three panels per row.))\n\n[[A man and woman are standing amid the fragments.]]\n\nMan: There's too much. And so little feels important.\n\n[[The jagged edge of the shaded area is encroaching on the sides of the panel.]]\n\nWhat do you do?\n\n[[We see them from farther away through a rough hole in the shaded area. Bits continue to fall around them.]]\n\n[[She takes his hand.]]\n\n{{Title text: I love the idea here, though of course it's not a great-quality drawing or scan.}}", u'alt': u"I love the idea here, though of course it's not a great-quality drawing or scan.", u'day': u'1'}, {u'img': u'http://imgs.xkcd.com/comics/barrel_part_4.jpg', u'title': u'Barrel - Part 4', u'month': u'1', u'num': 25, u'link': u'', u'year': u'2006', u'news': u'', u'safe_title': u'Barrel - Part 4', u'transcript': u'[[The barrel is shown, floating sideways in a choppy sea. The boy can not be seen]]\n{{title text: :( }}', u'alt': u':(', u'day': u'1'}, {u'img': u'http://imgs.xkcd.com/comics/fourier.jpg', u'title': u'Fourier', u'month': u'1', u'num': 26, u'link': u'', u'year': u'2006', u'news': u'', u'safe_title': u'Fourier', u'transcript': u'[[ Person talks on phone.  Cat with many sharp points looks on. ]]\nPerson on phone: Hi, Dr. Elizabeth?  Yeah, uh ... I accidentally took the Fourier transform of my cat ...\nCat: Meow!\n{{alt-text: That cat has some serious periodic components}}', u'alt': u'That cat has some serious periodic components', u'day': u'1'}, {u'img': u'http://imgs.xkcd.com/comics/meat_cereals.jpg', u'title': u'Meat Cereals', u'month': u'1', u'num': 27, u'link': u'', u'year': u'2006', u'news': u'', u'safe_title': u'Meat Cereals', u'transcript': u'[[A collection of fictional meat based cereals]]\nPork Loops\nMice Krispies\nHammios\nFrosted Bacon Flakes\nScrapple Jacks\nHoney Bunches of Goats\n{{Alt: Disgusting}', u'alt': u'Disgusting', u'day': u'1'}, {u'img': u'http://imgs.xkcd.com/comics/elefino.jpg', u'title': u'Elefino', u'month': u'1', u'num': 28, u'link': u'', u'year': u'2006', u'news': u'', u'safe_title': u'Elefino', u'transcript': u"Q: What do you get when you cross an Elephant with a Rhino?\n[[Picture of elephant, mathematical addition symbol, picture of rhino, equals sign, large question mark]]\nA: I haven't a goddamn clue.\n[[The correct answer to the joke is given in the title text]]\n{{title text: Hell if I know}}", u'alt': u'Hell if I know', u'day': u'1'}, {u'img': u'http://imgs.xkcd.com/comics/hitler.jpg', u'title': u'Hitler', u'month': u'1', u'num': 29, u'link': u'', u'year': u'2006', u'news': u'', u'safe_title': u'Hitler', u'transcript': u"Learning about the Holocaust has really shaken my belief in God.\nYou know, as a young man, Hitler was rejected from art school.\nYeah... shame he didn't get in\nWell, have you seen any of his paintings? They're awful. Defy all rules of composition.\nWhat are you suggesting?\nMaybe there is a god, but he's a real art lover.\nThis is why I don't go out in public with you.\n{{Alt text: So he's saying that God thought Hitler's art was so bad that the Holocaust was an acceptable alternative.  It's no secret that the hat guy is closely based on Aram, from Men in Hats.}}", u'alt': u"So he's saying that God thought Hitler's art was so bad that the Holocaust was an acceptable alternative.  It's no secret that the hat guy is closely based on Aram, from Men in Hats.", u'day': u'1'}, {u'img': u'http://imgs.xkcd.com/comics/donner.jpg', u'title': u'Donner', u'month': u'1', u'num': 30, u'link': u'', u'year': u'2006', u'news': u'', u'safe_title': u'Donner', u'transcript': u'[[Three people stand in the foyer of a restaurant. A sign above the entryway reads "JOE\'S" and there is a menu next to it. In front of the entryway, there\'s a host behind a podium. A sign on the podium reads "EAT IN".]]\nHost: Donner, party of four?\nMan: Actually, never mind.\nWoman: We\'re full.\n{{title text: Some people haven\'t heard of the Donner Party.  They were pioneers who got stranded and likely resorted to cannibalism.}}', u'alt': u"Some people haven't heard of the Donner Party.  They were pioneers who got stranded and likely resorted to cannibalism.", u'day': u'1'}, {u'img': u'http://imgs.xkcd.com/comics/barrel_part_5.jpg', u'title': u'Barrel - Part 5', u'month': u'1', u'num': 31, u'link': u'', u'year': u'2006', u'news': u'', u'safe_title': u'Barrel - Part 5', u'transcript': u'[[Boy floating on barrel in ocean]]\n[[Zoomed out view of boy floating on barrel in ocean]]\n[[Ferret with airplane wings and tail above the ocean]]\n[[The empty ocean]]\n[[Flying ferret carrying the boy to safety]]\n[[Ocean with ferret carrying boy in distance, sun on the horizon]]\n{{title text: Too good not to happen.}}', u'alt': u'Too good not to happen.', u'day': u'1'}, {u'img': u'http://imgs.xkcd.com/comics/pillar.jpg', u'title': u'Pillar', u'month': u'1', u'num': 32, u'link': u'', u'year': u'2006', u'news': u'', u'safe_title': u'Pillar', u'transcript': u"This one is mostly by my little brother, Doug.\n[[Person on a tall pillar is talking to person on the group]]\nPerson on pillar: The sky is so blue, and all the leaves are green.\nPerson on ground: Haven' t you ever wondered if we really see the same colors as everyone else? It's all perception.\nPerson on pillar: Well, you might as well call into question all of human experience. Who really knows what world someone else sees?\nPerson on ground: Yeah, I guess.\nPerson on pillar: Anyway, can you help me down from this pole?\nPerson on ground: What pole?\n{{Title Text: A comic by my brother Doug, redrawn and rewritten by me}}", u'alt': u'A comic by my brother Doug, redrawn and rewritten by me', u'day': u'1'}, {u'img': u'http://imgs.xkcd.com/comics/self-reference.jpg', u'title': u'Self-reference', u'month': u'1', u'num': 33, u'link': u'', u'year': u'2006', u'news': u'', u'safe_title': u'Self-reference', u'transcript': u'[[Guy standing alone]] Guy: I promise never to never again squeeze humor out of self-reference.\n[[Guy standing alone]]\n[[Guy standing alone]] Guy: God dammit.\n{{title text: I think about self-reference a lot.  Example: this comment.}}', u'alt': u'I think about self-reference a lot.  Example: this comment.', u'day': u'1'}, {u'img': u'http://imgs.xkcd.com/comics/flowers.jpg', u'title': u'Flowers', u'month': u'1', u'num': 34, u'link': u'', u'year': u'2006', u'news': u'', u'safe_title': u'Flowers', u'transcript': u'[[A sketch of flowers, drawn in red and green]]', u'alt': u'This is actually pencil on paper, just inverted and colored', u'day': u'1'}, {u'img': u'http://imgs.xkcd.com/comics/sheep.jpg', u'title': u'Sheep', u'month': u'1', u'num': 35, u'link': u'', u'year': u'2006', u'news': u'', u'safe_title': u'Sheep', u'transcript': u"Heading: Another from my high-school notebooks.\n[[A sheep and a potted saguaro cactus linked by an arcing yellow electricity bolt, drawn on graph paper]]\n{{title text: I think it's the sheep zapping the cactus and not vice-versa}}", u'alt': u"I think it's the sheep zapping the cactus and not vice-versa", u'day': u'1'}, {u'img': u'http://imgs.xkcd.com/comics/scientists.jpg', u'title': u'Scientists', u'month': u'1', u'num': 36, u'link': u'', u'year': u'2006', u'news': u'', u'safe_title': u'Scientists', u'transcript': u'In what scientists are calling "pretty gay," I can\'t find my shoes.\n{{ alt: A leading expert characterized the situation as \'retarded\' }}', u'alt': u"A leading expert characterized the situation as 'retarded'", u'day': u'1'}, {u'img': u'http://imgs.xkcd.com/comics/hyphen.jpg', u'title': u'Hyphen', u'month': u'1', u'num': 37, u'link': u'', u'year': u'2006', u'news': u'', u'safe_title': u'Hyphen', u'transcript': u"{{Headline: My hobby: whenever calls something an [adjective]-ass [noun], I mentally move the hyphen one word to the right.}}\n[[One man is talking to another about a car that resembles a Volkswagen Beetle]]\nMan: Man, that's a sweet ass-car.\n{{Title text: I do this constantly}}", u'alt': u'I do this constantly', u'day': u'1'}, {u'img': u'http://imgs.xkcd.com/comics/apple_jacks.jpg', u'title': u'Apple Jacks', u'month': u'1', u'num': 38, u'link': u'', u'year': u'2006', u'news': u'', u'safe_title': u'Apple Jacks', u'transcript': u"[[Father is standing holding a bowl of Scrapple Jacks in his hand. Son is sitting on the floor playing video games.]]\nFather: Hey, these don't taste like apples!\nSon: Fuck off, dad.\n{{alt text: There used to be these ads, see . . .}}", u'alt': u'There used to be these ads, see . . .', u'day': u'1'}, {u'img': u'http://imgs.xkcd.com/comics/bowl.jpg', u'title': u'Bowl', u'month': u'1', u'num': 39, u'link': u'', u'year': u'2006', u'news': u'', u'safe_title': u'Bowl', u'transcript': u"[[A boy is glaring at a model sailing ship floating in a bowl of water.]]\nBoy: Sooner or later, my friend, one of us will run out of time.\n{{Alt: For the moment it's a standoff}}", u'alt': u"For the moment it's a standoff", u'day': u'1'}, {u'img': u'http://imgs.xkcd.com/comics/light.jpg', u'title': u'Light', u'month': u'1', u'num': 40, u'link': u'', u'year': u'2006', u'news': u'', u'safe_title': u'Light', u'transcript': u'[[A crowd of figures stand around in the dark. One figure is illuminated by a beam of light.]]\nIn a dark and confusing world, you burn brightly. I never feel lost.\n{{Alt-text: Like a beacon.}}', u'alt': u'Like a beacon', u'day': u'1'}, {u'img': u'http://imgs.xkcd.com/comics/unspeakable_pun.jpg', u'title': u'Old Drawing', u'month': u'1', u'num': 41, u'link': u'', u'year': u'2006', u'news': u'', u'safe_title': u'Old Drawing', u'transcript': u"[[A tree holding a chainsaw over a recently cut-down tree.]]\nI found this in one of my high-school notebooks. I think I drew it just to take revenge on people snooping through my stuff.\nCut-down tree: WELL, YOU STUMPED ME...\n{{I don't want to talk about it}}", u'alt': u"I don't want to talk about it", u'day': u'1'}, {u'img': u'http://imgs.xkcd.com/comics/geico.jpg', u'title': u'Geico', u'month': u'1', u'num': 42, u'link': u'', u'year': u'2006', u'news': u'', u'safe_title': u'Geico', u'transcript': u'I just saved a bunch of money on my car insurance by threatening my agent with a golf club.\n{{title text: David did this}}', u'alt': u'David did this', u'day': u'1'}, {u'img': u'http://imgs.xkcd.com/comics/red_spiders_2.jpg', u'title': u'Red Spiders 2', u'month': u'1', u'num': 43, u'link': u'', u'year': u'2006', u'news': u'', u'safe_title': u'Red Spiders 2', u'transcript': u'[[Red spiders, with round appendages at the end of each of their six legs, are seen navigating an environment of blocks and other geometric constructions]]\n{{title text: This was actually drawn years before Red Spiders}}', u'alt': u'This was actually drawn years before Red Spiders', u'day': u'1'}, {u'img': u'http://imgs.xkcd.com/comics/love.jpg', u'title': u'Love', u'month': u'1', u'num': 44, u'link': u'', u'year': u'2006', u'news': u'', u'safe_title': u'Love', u'transcript': u'[[A man and a woman stand facing one another]]\nMan: I love you!\nWoman: I love you!\nMan: I love you more!\nWoman: Yeah.\n[[A man and a woman stand facing one another - saying nothing.]]\n{{Alt-text: This one makes me wince every time I think about it}}', u'alt': u'This one makes me wince every time I think about it', u'day': u'1'}, {u'img': u'http://imgs.xkcd.com/comics/schrodinger.jpg', u'title': u'Schrodinger', u'month': u'1', u'num': 45, u'link': u'', u'year': u'2006', u'news': u'', u'safe_title': u'Schrodinger', u'transcript': u"[[Label: Schr\xc3\xb6dinger's Comic]]\n[[Two figures standing, one with a black hat]]\nThe last panel of this comic is both funny and not funny at the same time.\nUntil you read it, there's no way to tell which it will end up being.\nShit.\n{{alt: There was no alt-text until you moused over}}", u'alt': u'There was no alt-text until you moused over', u'day': u'4'}, {u'img': u'http://imgs.xkcd.com/comics/secrets.jpg', u'title': u'Secrets', u'month': u'1', u'num': 46, u'link': u'', u'year': u'2006', u'news': u'', u'safe_title': u'Secrets', u'transcript': u"I just want you to share in my secrets\n[[lonely looking girl staring down]]\nand not run away\n{{alt: I'm a big fan of Kurt Halsey}}", u'alt': u"I'm a big fan of Kurt Halsey", u'day': u'6'}, {u'img': u'http://imgs.xkcd.com/comics/counter-red-spiders.jpg', u'title': u'Counter-Red Spiders', u'month': u'1', u'num': 47, u'link': u'', u'year': u'2006', u'news': u'', u'safe_title': u'Counter-Red Spiders', u'transcript': u'[[A stack of stick figures, standing on each others shoulders extends from the bottom of the frame to the top.  Cuboids hang in the air]]\nThe counter-red-spider offensive begins ...\n{{title text: I hope we can stop them}}', u'alt': u'I hope we can stop them', u'day': u'9'}, {u'img': u'http://imgs.xkcd.com/comics/found.jpg', u'title': u'Found', u'month': u'1', u'num': 48, u'link': u'', u'year': u'2006', u'news': u'', u'safe_title': u'Found', u'transcript': u'[[A male and female stick figure are standing on a white hill (presumably snow) with a grey sky covered with thick streaks of white, and small pink dots]]\nwe are just two people \nwho found each other\n{{No more, no less}}', u'alt': u'No more, no less', u'day': u'12'}, {u'img': u'http://imgs.xkcd.com/comics/want.jpg', u'title': u'Want', u'month': u'1', u'num': 49, u'link': u'', u'year': u'2006', u'news': u'', u'safe_title': u'Want', u'transcript': u'I want to be brave enough to tell you how I feel.\nI want to say "I love you" _before_ I hang up the phone for once.\nI want to drive all night with you, listening to mix tapes, not caring where we end up.\nOh, and I also really want to get with your sister.\nI mean, DAMN.\n{{title text: Well, she\'s pretty hot.}}', u'alt': u"Well, she's pretty hot.", u'day': u'14'}, {u'img': u'http://imgs.xkcd.com/comics/penny_arcade.jpg', u'title': u'Penny Arcade', u'month': u'1', u'num': 50, u'link': u'', u'year': u'2006', u'news': u'', u'safe_title': u'Penny Arcade', u'transcript': u"Tycho: You know what? If you've never played the 1995 SNES RPG 'Seiken Densetsu' don't even _bother_ reading today's strip. We don't _need_ your kind here.\n{{title text: Of course, Penny Arcade has already mocked themselves for this. They don't care.}}", u'alt': u"Of course, Penny Arcade has already mocked themselves for this.  They don't care.", u'day': u'17'}]



xkcd_url=None 
xkcd_json = None


def xkcd_search(search_string):
    if not search_string:
        print 'Emoji not found :('

    if search_string in '*,random,anything'.split(','):
        random_xkxd_num = random.randint(1, 1721) 
        num = random_xkxd_num
        xkcd_json_url = 'http://xkcd.com/' + str(num) + '/info.0.json'
        x = requests.get(xkcd_json_url)
        xkcd_json = json.loads(x.content)
        print 'A RANDOM XKCD COMIC'
        return xkcd_json
    tokens = re.sub(r"[^a-zA-Z0-9\s]",' ',search_string).lower().split()
    print tokens

    result_arr = []

    for token in tokens:
        for xkcd_comic in xkcd_list:
            if token in xkcd_comic['alt'].lower():
                print 'HurrrayHurrray!!!!!'
                result_arr.append(xkcd_comic)

    random.shuffle(result_arr)
    print result_arr
    return result_arr[0]


    

def post_facebook_message(fbid, recevied_message):
    xkcd_url= None 
    try:
        if int(recevied_message) < 1271:
            num = int(recevied_message)
            xkcd_json_url = 'http://xkcd.com/' + str(num) + '/info.0.json'
            x = requests.get(xkcd_json_url)
            xkcd_json = json.loads(x.content)
            xkcd_url = json.dumps(xkcd_json['img'])
            print xkcd_url[1:-1]
    except:
        xkcd_json = xkcd_search(recevied_message)
        #print 'Hurray WOohiooo'
        xkcd_url = json.dumps(xkcd_json['img'])
        print xkcd_url[1:-1]


    message_greeting_txt = {
          "setting_type":"greeting",
          "greeting":{
            "text":"Hello there!  You can try finding out different emojis by typing in keywords. Like try  smiling , face , tongue etc."
          }}
    message_generic_template = {
            "attachment":{
              "type":"template",
              "payload":{
                "template_type":"generic",
                "elements":[
                  {
                    "title":"Welcome to Sec 23 Giving Back Society",
                    "image_url":"http://worldversus.com/img/ironman.jpg",
                    "subtitle":"We\'ve got the right hat for everyone.",
                    "buttons":[
                      {
                        "type":"web_url",
                        "url":"https://google.com/",
                        "title":"View Website"
                      } ,
                      {
                        "type":"postback",
                        "title":"Start Chatting",
                        "payload":"USER_DEFINED_PAYLOAD"
                      }]}]}}}
    message_image = {
        "attachment":{
          "type":"image",
          "payload":{
            #"url":"http://thecatapi.com/api/images/get?format=src&type=png"
            "url" : xkcd_url[1:-1]
          }}}
    message_text = {
        "text": xkcd_json['alt']
        }
    

    greeting_txt_url = 'https://graph.facebook.com/v2.6/me/thread_settings?access_token=%s'%PAGE_ACCESS_TOKEN
    post_message_url = 'https://graph.facebook.com/v2.6/me/messages?access_token=%s'%PAGE_ACCESS_TOKEN
    txt_msg = json.dumps({"recipient":{"id":fbid}, "message":message_text})
    response_img_msg = json.dumps({"recipient":{"id":fbid}, "message":message_image})
    #response_temp_msg = json.dumps({"recipient":{"id":fbid}, "message":message_generic_template})
    #response_greeting_msg = json.dumps({"recipient":{"id":fbid}, "message":message_greeting_txt})
    

    status = requests.post(post_message_url, headers={"Content-Type": "application/json"},data=response_img_msg)
    pprint(status.json())
    status = requests.post(post_message_url, headers={"Content-Type": "application/json"},data=txt_msg)
    pprint(status.json())


class MyQuoteBotView(generic.View):
    def get(self, request, *args, **kwargs):
        if self.request.GET['hub.verify_token'] == VERIFY_TOKEN:
            return HttpResponse(self.request.GET['hub.challenge'])
        else:
            return HttpResponse('Error, invalid token')
        
    @method_decorator(csrf_exempt)
    def dispatch(self, request, *args, **kwargs):
        return generic.View.dispatch(self, request, *args, **kwargs)

    # Post function to handle Facebook messages
    def post(self, request, *args, **kwargs):
        # Converts the text payload into a python dictionary
        print 'Inside post function'
        incoming_message = json.loads(self.request.body.decode('utf-8'))
        # Facebook recommends going through every entry since they might send
        # multiple messages in a single call during high load
        for entry in incoming_message['entry']:
            for message in entry['messaging']:
                # Check to make sure the received call is a message call
                # This might be delivery, optin, postback for other events 
                if 'message' in message:
                    print 'inside first if'
                    # Print the message to the terminal
                    # Assuming the sender only sends text. Non-text messages like stickers, audio, pictures
                    # are sent as attachments and must be handled accordingly. 
                    #if message['message']['text']:
                    #    print 'inside second if'
                    print message

                    try:
                        post_facebook_message(message['sender']['id'], message['message']['text'])
                    except:
                        post_facebook_message(message['sender']['id'], 'random')
        return HttpResponse()    



def index(request):
    print 'Hello!'
    test()

def test():
    post_facebook_message('1366822393332584','22')









